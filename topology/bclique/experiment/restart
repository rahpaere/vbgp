#! /bin/sh

rundir=/home/burgess/vbgp/topology/bclique/experiment

if test $# -ne 2
then
	echo Usage: $0 SIZE COUNT
	exit 1
fi

dir=`pwd`
n=$1
dest=`expr $n + 1`
count=$2

echo `date`: Starting initial convergence.
${rundir}/start $n
for i in `seq $n`
do
	ssh 192.168.1.$i ${dir}/config/nodes/start$i
done
ssh 192.168.1.${dest} ${dir}/config/routes/start1
ssh 192.168.1.${dest} ${dir}/config/routes/start2
${rundir}/converge $n 60
${rundir}/stop $n

for current in `seq ${count}`
do
	echo `date`: Beginning experiment $current.
	${rundir}/start $n
	ssh 192.168.1.${dest} ${dir}/config/routes/stop1
	ssh 192.168.1.${dest} ${dir}/config/routes/stop2
	${rundir}/converge $n 60
	${rundir}/save $current
	${rundir}/stop $n
done

echo `date`: Cleaning up.
for i in `seq $n`
do
	ssh 192.168.1.$i ${dir}/config/nodes/stop$i
done
ssh 192.168.1.${dest} ${dir}/config/routes/stop1
ssh 192.168.1.${dest} ${dir}/config/routes/stop2
